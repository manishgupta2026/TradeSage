name: TradeSage Trading Bot

on:
  schedule:
    # Run at 09:25 AM IST (03:55 UTC) - 5 mins before market open
    - cron: '55 3 * * 1-5'
    # Run at 02:55 PM IST (09:25 UTC) - Before market close
    - cron: '25 9 * * 1-5'
  workflow_dispatch:  # Allow manual triggers

jobs:
  paper-trading:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      
    - name: Set up Python 3.10
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        cache: 'pip'
    
    - name: Configure Git Authentication
      run: |
        git config --global url."https://${{ secrets.GITHUB_TOKEN }}@github.com/".insteadOf "https://github.com/"
    
    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install git+https://github.com/twopirllc/pandas-ta.git@development
    
    - name: Create .env file
      run: |
        echo "ANGEL_MARKET_KEY=${{ secrets.ANGEL_MARKET_KEY }}" >> .env
        echo "ANGEL_HISTORICAL_KEY=${{ secrets.ANGEL_HISTORICAL_KEY }}" >> .env
        echo "TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }}" >> .env
        echo "TELEGRAM_CHAT_ID=${{ secrets.TELEGRAM_CHAT_ID }}" >> .env
        echo "ANGEL_CLIENT_ID=${{ secrets.ANGEL_CLIENT_ID }}" >> .env
        echo "ANGEL_MPIN=${{ secrets.ANGEL_MPIN }}" >> .env
        echo "ANGEL_TOTP_SECRET=${{ secrets.ANGEL_TOTP_SECRET }}" >> .env
    
    - name: Restore Paper Portfolio (if exists)
      uses: actions/cache@v3
      with:
        path: data/paper_portfolio.json
        key: paper-portfolio-${{ github.run_id }}
        restore-keys: |
          paper-portfolio-
    
    - name: Run Trading Bot (Paper Mode - Scan & Exit Check)
      env:
        PYTHONPATH: .
        TRADESAGE_MODE: paper
        TRADESAGE_TRADER_FILE: data/paper_portfolio.json
      run: |
        # Run a single scan cycle with exit checking
        python -c "
        import os
        import sys
        sys.path.append('.')
        from src.paper.paper_trader import PaperTrader
        from src.engine.scanner import NSEScanner
        from src.engine.data_manager import DataManager
        import asyncio
        from telegram import Bot
        
        async def scan_and_report():
            # Initialize
            trader = PaperTrader(portfolio_file='data/paper_portfolio.json', initial_capital=50000)
            dm = DataManager()
            scanner = NSEScanner(dm)
            bot = Bot(token=os.getenv('TELEGRAM_BOT_TOKEN'))
            chat_id = os.getenv('TELEGRAM_CHAT_ID')
            
            # Check for exits on existing positions first
            exit_msgs = []
            if trader.portfolio.get('holdings'):
                current_prices = {}
                for ticker in trader.portfolio['holdings'].keys():
                    df = dm.fetch_data(ticker, use_cache=False)
                    if not df.empty:
                        current_prices[ticker] = df.iloc[-1]['Close']
                
                exit_msgs = trader.update_portfolio(current_prices)
            
            # Scan market for new opportunities
            results = scanner.scan_market()
            
            msg = 'ü§ñ **GitHub Actions Scan**\n\n'
            
            # Report exits first
            if exit_msgs:
                msg += '**üìà Position Exits:**\n'
                for exit_msg in exit_msgs:
                    msg += f'{exit_msg}\n'
                msg += '\n'
            
            # Report new signals
            if results:
                msg += '**üîç New Signals:**\n'
                for res in results[:3]:
                    ticker = res['ticker']
                    price = res['price']
                    
                    # Execute paper trade
                    signal = {
                        'ticker': ticker,
                        'action': 'BUY',
                        'price': price,
                        'sl': price * 0.98,
                        'target': price * 1.05
                    }
                    trade_msg = trader.execute_trade(signal)
                    if trade_msg:
                        msg += f'üìä {ticker} @ ‚Çπ{price}\n{trade_msg}\n\n'
            
            # Portfolio Summary
            summary = trader.get_summary()
            msg += f'\nüíº **Portfolio:** ‚Çπ{summary[\"balance\"]:,.0f} | '
            msg += f'Open: {summary[\"open_positions\"]} | '
            msg += f'Closed: {summary[\"closed_trades\"]} | '
            msg += f'ROI: {summary[\"roi\"]:.2f}%'
            
            await bot.send_message(chat_id=chat_id, text=msg, parse_mode='Markdown')
        
        asyncio.run(scan_and_report())
        "
    
    - name: Save Paper Portfolio
      uses: actions/cache@v3
      with:
        path: data/paper_portfolio.json
        key: paper-portfolio-${{ github.run_id }}
