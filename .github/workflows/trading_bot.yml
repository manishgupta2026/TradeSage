name: TradeSage Trading Bot

on:
  schedule:
    # Run at 09:25 AM IST (03:55 UTC) - 5 mins before market open
    - cron: '55 3 * * 1-5'
    # Run at 02:55 PM IST (09:25 UTC) - Before market close
    - cron: '25 9 * * 1-5'
  workflow_dispatch:  # Allow manual triggers

jobs:
  paper-trading:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      
    - name: Set up Python 3.12
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
        cache: 'pip'
    
    - name: Configure Git Authentication
      run: |
        git config --global url."https://${{ secrets.GITHUB_TOKEN }}@github.com/".insteadOf "https://github.com/"
    
    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Create .env file
      run: |
        echo "ANGEL_MARKET_KEY=${{ secrets.ANGEL_MARKET_KEY }}" >> .env
        echo "ANGEL_HISTORICAL_KEY=${{ secrets.ANGEL_HISTORICAL_KEY }}" >> .env
        echo "TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }}" >> .env
        echo "TELEGRAM_CHAT_ID=${{ secrets.TELEGRAM_CHAT_ID }}" >> .env
        echo "ANGEL_CLIENT_ID=${{ secrets.ANGEL_CLIENT_ID }}" >> .env
        echo "ANGEL_MPIN=${{ secrets.ANGEL_MPIN }}" >> .env
        echo "ANGEL_TOTP_SECRET=${{ secrets.ANGEL_TOTP_SECRET }}" >> .env
    
    - name: Restore Paper Portfolio (if exists)
      uses: actions/cache@v3
      with:
        path: |
          data/paper_portfolio.json
          data/angel_scrip_master.json
        key: paper-portfolio-${{ github.run_id }}
        restore-keys: |
          paper-portfolio-
    
    - name: Run Trading Bot (Paper Mode - Scan & Exit Check)
      env:
        PYTHONPATH: .
        TRADESAGE_MODE: paper
        TRADESAGE_TRADER_FILE: data/paper_portfolio.json
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        ANGEL_MARKET_KEY: ${{ secrets.ANGEL_MARKET_KEY }}
        ANGEL_HISTORICAL_KEY: ${{ secrets.ANGEL_HISTORICAL_KEY }}
        ANGEL_CLIENT_ID: ${{ secrets.ANGEL_CLIENT_ID }}
        ANGEL_MPIN: ${{ secrets.ANGEL_MPIN }}
        ANGEL_TOTP_SECRET: ${{ secrets.ANGEL_TOTP_SECRET }}
      run: |
        # Run a single scan cycle with exit checking
        python -c "
        import os
        import sys
        sys.path.append('.')
        from src.paper.paper_trader import PaperTrader
        from src.engine.scanner import NSEScanner
        from src.engine.data_manager import DataManager
        import asyncio
        from telegram import Bot
        
        async def scan_and_report():
            # Initialize
            trader = PaperTrader(portfolio_file='data/paper_portfolio.json', initial_capital=50000)
            dm = DataManager()
            scanner = NSEScanner(dm)
            
            # Get Telegram credentials
            telegram_token = os.getenv('TELEGRAM_BOT_TOKEN')
            chat_id = os.getenv('TELEGRAM_CHAT_ID')
            
            # Check if Telegram is configured
            telegram_enabled = bool(telegram_token and telegram_token.strip() and chat_id and chat_id.strip())
            
            if telegram_enabled:
                bot = Bot(token=telegram_token)
            else:
                print('âš ï¸  Telegram bot token not configured. Running without notifications.')
            
            # Check for exits on existing positions first
            # Update Portfolio (Paper Trading)
            if trader:
                print('Updating portfolio...')
                current_prices = {}
                prev_closes = {}
                
                # Fetch live data for held stocks
                # Fetch live data for held stocks
                for ticker in trader.portfolio['holdings'].keys():
                    df = dm.fetch_data(ticker, use_cache=False)
                    if not df.empty:
                        current_prices[ticker] = df.iloc[-1]['Close']
                        if len(df) > 1:
                            prev_closes[ticker] = df.iloc[-2]['Close']
                exit_msgs = trader.update_portfolio(current_prices)
            
            # Scan market for new opportunities
            results = scanner.scan_market()
            
            msg = 'ğŸ¤– **GitHub Actions Scan**\n\n'
            
            # Report exits first
            if exit_msgs:
                msg += '**ğŸ“ˆ Position Exits:**\n'
                for exit_msg in exit_msgs:
                    msg += f'{exit_msg}\n'
                msg += '\n'
            
            # Report new signals
            if results:
                msg += '**ğŸ” New Signals:**\n'
                for res in results[:3]:
                    ticker = res['ticker']
                    price = res['price']
                    
                    # Execute paper trade
                    signal = {
                        'ticker': ticker,
                        'action': 'BUY',
                        'price': price,
                        'sl': price * 0.98,
                        'target': price * 1.05
                    }
                    trade_msg = trader.execute_trade(signal)
                    if trade_msg:
                        msg += f'ğŸ“Š {ticker} @ â‚¹{price}\n{trade_msg}\n'
                        # Add Sentiment Info if available
                        if res.get('sentiment_score'):
                             s_score = res['sentiment_score']
                             s_emoji = 'ğŸ¤–' if s_score > 0 else 'âš ï¸'
                             msg += f'{s_emoji} **Sentiment:** {s_score} ({res["sentiment_reason"]})\n'
                        msg += '\n'
            
            # Portfolio Summary
            summary = trader.get_summary(current_prices, prev_closes)
            
            # Format P&L with emoji
            day_pnl_emoji = 'ğŸŸ¢' if summary['todays_pnl'] >= 0 else 'ğŸ”´'
            total_pnl_emoji = 'ğŸŸ¢' if summary['total_pnl'] >= 0 else 'ğŸ”´'
            
            msg += f'\nğŸ’¼ **Portfolio Update**\n'
            msg += f'ğŸ’° **Equity:** â‚¹{summary[\"equity\"]:,.2f}\n'
            msg += f'ğŸ’µ **Cash:** â‚¹{summary[\"balance\"]:,.2f}\n'
            msg += f'{day_pnl_emoji} **Today:** â‚¹{summary[\"todays_pnl\"]:,.2f}\n'
            msg += f'{total_pnl_emoji} **Total P&L:** â‚¹{summary[\"total_pnl\"]:,.2f} ({summary[\"roi\"]:.2f}%)\n'
            msg += f'ğŸ“Š **Trades:** {summary[\"open_positions\"]} Open | {summary[\"closed_trades\"]} Closed\n'
            
            # List Holdings
            if summary['holdings']:
                msg += '\nğŸ“‚ **Holdings:**\n'
                for h in summary['holdings']:
                    pnl_emoji = 'ğŸŸ¢' if h['pnl'] >= 0 else 'ğŸ”´'
                    msg += f'ğŸ”¹ **{h["ticker"]}** ({h["qty"]}):\n'
                    msg += f'   Avg: â‚¹{h["avg"]:,.2f} â CMP: â‚¹{h["cmp"]:,.2f}\n'
                    msg += f'   {pnl_emoji} P&L: â‚¹{h["pnl"]:,.2f} ({h["pnl_pct"]:.2f}%)\n'
            
            # Send notification if Telegram is enabled
            if telegram_enabled:
                await bot.send_message(chat_id=chat_id, text=msg, parse_mode='Markdown')
                print('âœ… Telegram notification sent successfully')
            else:
                print('ğŸ“Š Scan Results (No Telegram notification):')
                print(msg)
        
        asyncio.run(scan_and_report())
        "
    
    - name: Save Paper Portfolio
      uses: actions/cache@v3
      with:
        path: |
          data/paper_portfolio.json
          data/angel_scrip_master.json
        key: paper-portfolio-${{ github.run_id }}
