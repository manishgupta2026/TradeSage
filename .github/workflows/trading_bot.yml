name: TradeSage Trading Bot

on:
  schedule:
    # Run at 09:25 AM IST (03:55 UTC) - 5 mins before market open
    - cron: '55 3 * * 1-5'
    # Run at 02:55 PM IST (09:25 UTC) - Before market close
    - cron: '25 9 * * 1-5'
  workflow_dispatch:  # Allow manual triggers

jobs:
  paper-trading:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      
    - name: Set up Python 3.12
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
        cache: 'pip'
    
    - name: Configure Git Authentication
      run: |
        git config --global url."https://${{ secrets.GITHUB_TOKEN }}@github.com/".insteadOf "https://github.com/"
    
    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Create .env file
      run: |
        echo "ANGEL_MARKET_KEY=${{ secrets.ANGEL_MARKET_KEY }}" >> .env
        echo "ANGEL_HISTORICAL_KEY=${{ secrets.ANGEL_HISTORICAL_KEY }}" >> .env
        echo "TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }}" >> .env
        echo "TELEGRAM_CHAT_ID=${{ secrets.TELEGRAM_CHAT_ID }}" >> .env
        echo "ANGEL_CLIENT_ID=${{ secrets.ANGEL_CLIENT_ID }}" >> .env
        echo "ANGEL_MPIN=${{ secrets.ANGEL_MPIN }}" >> .env
        echo "ANGEL_TOTP_SECRET=${{ secrets.ANGEL_TOTP_SECRET }}" >> .env
    
    - name: Restore Paper Portfolio (if exists)
      uses: actions/cache@v3
      with:
        path: |
          data/paper_portfolio.json
          data/angel_scrip_master.json
        key: paper-portfolio-${{ github.run_id }}
        restore-keys: |
          paper-portfolio-
    
    - name: Run Trading Bot (Paper Mode - Scan & Exit Check)
      env:
        PYTHONPATH: .
        TRADESAGE_MODE: paper
        TRADESAGE_TRADER_FILE: data/paper_portfolio.json
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        ANGEL_MARKET_KEY: ${{ secrets.ANGEL_MARKET_KEY }}
        ANGEL_HISTORICAL_KEY: ${{ secrets.ANGEL_HISTORICAL_KEY }}
        ANGEL_CLIENT_ID: ${{ secrets.ANGEL_CLIENT_ID }}
        ANGEL_MPIN: ${{ secrets.ANGEL_MPIN }}
        ANGEL_TOTP_SECRET: ${{ secrets.ANGEL_TOTP_SECRET }}
        GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
      run: |
        python src/utils/run_workflow.py
    
    - name: Save Paper Portfolio
      uses: actions/cache@v3
      with:
        path: |
          data/paper_portfolio.json
          data/angel_scrip_master.json
        key: paper-portfolio-${{ github.run_id }}
